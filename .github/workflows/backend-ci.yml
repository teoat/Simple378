name: Backend CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Run weekly on Sunday at midnight

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'poetry'
          cache-dependency-path: backend/poetry.lock
      
      - name: Install Poetry
        run: pip install poetry # Poetry is typically installed globally or via pip in CI
        working-directory: backend
      
      - name: Configure Poetry virtual environment
        run: poetry config virtualenvs.in-project true
        working-directory: backend

      - name: Install dependencies
        run: poetry install --no-root
        working-directory: backend
      
      - name: Lint with Ruff
        run: poetry run ruff check .
        working-directory: backend
      
      - name: Format Check with Black
        run: poetry run black --check .
        working-directory: backend
      
      - name: Sort Imports Check with isort
        run: poetry run isort --check .
        working-directory: backend

      - name: Type Check with Mypy
        run: poetry run mypy app
        working-directory: backend

      - name: Run security checks with Bandit
        run: poetry run bandit -r . -ll -x tests
        working-directory: backend

      - name: Audit dependencies with pip-audit
        run: poetry run pip install pip-audit && poetry run pip-audit
        working-directory: backend

      - name: Run tests
        run: poetry run pytest
        working-directory: backend

  scheduled-dependency-checks:
    runs-on: ubuntu-latest
    needs: test # Ensures that main checks pass before running maintenance checks
    if: github.event_name == 'schedule' # Only run this job on schedule trigger
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'poetry'
          cache-dependency-path: backend/poetry.lock
      
      - name: Install Poetry
        run: pip install poetry
        working-directory: backend
      
      - name: Configure Poetry virtual environment
        run: poetry config virtualenvs.in-project true
        working-directory: backend

      - name: Install dependencies
        run: poetry install --no-root
        working-directory: backend
      
      - name: Check for outdated dependencies
        run: poetry show --outdated || true # '|| true' to prevent job failure if outdated deps found
        working-directory: backend
      
      - name: Audit dependencies for vulnerabilities
        run: poetry run pip install pip-audit && poetry run pip-audit || true # '|| true' to prevent job failure if vulns found
        working-directory: backend

