import{j as e,b as P,c as R,u as _}from"./query-vendor-CvBDT0OD.js";import{a as l}from"./react-vendor-BuVNz1jA.js";import{k as T,m as E,j as S}from"./index-BlWFTSEC.js";import{O as A,r as I,m as O,U as q,Q,X as B,o as K,g as $,z as p}from"./ui-vendor-DqTYRHc5.js";import{P as z}from"./ProcessingPipeline-BQ8w1x9G.js";import{u as G}from"./useWebSocket-M8ejPgyM.js";import{P as L}from"./PageErrorBoundary-BlW1gdj2.js";import"./viz-vendor-Yg1nQkEx.js";function M({id:u,date:t,description:i,amount:h,status:n,type:c}){return e.jsxs("div",{className:T("group flex items-center justify-between rounded-xl border p-4 backdrop-blur-sm transition-all hover:shadow-lg",n==="matched"?"border-green-500/50 bg-green-500/10 dark:bg-green-500/20 shadow-green-500/10":n==="flagged"?"border-red-500/50 bg-red-500/10 dark:bg-red-500/20 shadow-red-500/10":"border-yellow-500/30 bg-yellow-500/5 dark:bg-yellow-500/10 border-dashed shadow-yellow-500/5"),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"cursor-grab text-slate-400 hover:text-slate-600 active:cursor-grabbing dark:text-slate-500 dark:hover:text-slate-300",children:e.jsx(A,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 dark:text-white",children:i}),e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:[t," â€¢ ID: ",u]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:T("font-mono text-sm font-semibold",c==="expense"?"text-red-600 dark:text-red-400":"text-green-600 dark:text-green-400"),children:[c==="expense"?"-":"+","$",h.toFixed(2)]}),n==="matched"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"text-xs text-green-600 dark:text-green-400 font-medium",children:"Matched"})]}),n==="flagged"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5 text-red-500"}),e.jsx("span",{className:"text-xs text-red-600 dark:text-red-400 font-medium",children:"Flagged"})]}),n==="unmatched"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-5 w-5 rounded-full border-2 border-dashed border-yellow-400 dark:border-yellow-500"}),e.jsx("span",{className:"text-xs text-yellow-600 dark:text-yellow-400 font-medium",children:"Unmatched"})]})]})]})}function J({onUpload:u,showProcessing:t=!1,uploadId:i}){const[h,n]=l.useState(!1),[c,x]=l.useState([]),[o,g]=l.useState("idle"),[v,b]=l.useState("upload"),[f,m]=l.useState(0),[y,j]=l.useState("");G("/ws",{onMessage:s=>{s.type==="upload_progress"&&s.payload?.upload_id===i?m(s.payload.progress||0):s.type==="processing_stage"&&s.payload?.upload_id===i?(b(s.payload.stage||"upload"),m(s.payload.progress||0)):s.type==="processing_complete"&&s.payload?.upload_id===i?(b("complete"),m(100),g("success")):s.type==="processing_error"&&s.payload?.upload_id===i&&(j(s.payload.error||"Processing failed"),g("error"))}});const k=l.useCallback(s=>{s.preventDefault(),n(!0)},[]),C=l.useCallback(s=>{s.preventDefault(),n(!1)},[]),F=l.useCallback(s=>{s.preventDefault(),n(!1);const d=Array.from(s.dataTransfer.files);x(a=>[...a,...d])},[]),N=l.useCallback(s=>{if(s.target.files){const d=Array.from(s.target.files);x(a=>[...a,...d])}},[]),w=s=>{x(d=>d.filter((a,r)=>r!==s))},D=async()=>{c.length!==0&&(g("uploading"),b("upload"),m(0),j(""),u(c),t||setTimeout(()=>{g("success"),x([]),setTimeout(()=>g("idle"),3e3)},2e3))};return l.useEffect(()=>{if(o==="uploading"&&t){const s=["upload","virus_scan","ocr","metadata","forensics","indexing","complete"];let d=0;const a=setInterval(()=>{d<s.length-1?(d++,b(s[d]),m(d/(s.length-1)*100)):clearInterval(a)},2e3);return()=>clearInterval(a)}},[o,t]),e.jsxs("div",{className:"space-y-4",children:[t&&o==="uploading"&&e.jsx(z,{currentStage:v,progress:f,error:y,estimatedTimeRemaining:Math.max(0,Math.round((100-f)*.5))}),e.jsxs("div",{onDragOver:k,onDragLeave:C,onDrop:F,className:T("relative flex flex-col items-center justify-center rounded-lg border-2 border-dashed p-12 transition-colors backdrop-blur-sm",h?"border-purple-500 dark:border-cyan-500 bg-purple-50/50 dark:bg-purple-900/20":"border-slate-300 dark:border-slate-700 hover:bg-slate-50/50 dark:hover:bg-slate-800/50",o==="uploading"&&"opacity-50 pointer-events-none"),children:[e.jsx(q,{className:"h-12 w-12 text-slate-400"}),e.jsxs("p",{className:"mt-4 text-sm text-slate-600 dark:text-slate-400",children:[e.jsx("span",{className:"font-semibold text-blue-600 hover:text-blue-500 dark:text-blue-400",children:"Click to upload"})," ","or drag and drop"]}),e.jsx("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-500",children:"PDF, PNG, JPG up to 10MB"}),e.jsx("input",{type:"file",className:"absolute inset-0 cursor-pointer opacity-0",onChange:N,multiple:!0})]}),c.length>0&&e.jsxs("div",{className:"space-y-2",children:[c.map((s,d)=>e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-slate-200 bg-white p-3 dark:border-slate-700 dark:bg-slate-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Q,{className:"h-5 w-5 text-slate-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 dark:text-white",children:s.name}),e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:[(s.size/1024/1024).toFixed(2)," MB"]})]})]}),e.jsx("button",{onClick:()=>w(d),className:"text-slate-400 hover:text-red-500",children:e.jsx(B,{className:"h-5 w-5"})})]},d)),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsx("button",{onClick:D,disabled:o==="uploading",className:"inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 disabled:opacity-50",children:o==="uploading"?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"mr-2 h-4 w-4 animate-spin"}),"Uploading..."]}):o==="success"?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"mr-2 h-4 w-4"}),"Uploaded"]}):"Upload Files"})})]})]})}function V(){return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"h-8 w-64 bg-slate-200 dark:bg-slate-700 rounded animate-pulse"}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsx("div",{className:"h-8 w-48 bg-slate-200 dark:bg-slate-700 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-32 bg-slate-200 dark:bg-slate-700 rounded-lg animate-pulse"})]})]}),e.jsxs("div",{className:"backdrop-blur-lg bg-white/10 dark:bg-slate-900/20 rounded-xl border border-white/20 dark:border-slate-700/30 shadow-xl p-6",children:[e.jsx("div",{className:"h-6 w-40 bg-slate-200 dark:bg-slate-700 rounded animate-pulse mb-4"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[...Array(3)].map((u,t)=>e.jsx("div",{className:"h-10 bg-slate-200 dark:bg-slate-700 rounded animate-pulse"},t))}),e.jsx("div",{className:"h-32 bg-slate-200 dark:bg-slate-700 rounded-lg animate-pulse"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"backdrop-blur-lg bg-white/10 dark:bg-slate-900/20 rounded-xl border border-white/20 dark:border-slate-700/30 shadow-xl p-6",children:[e.jsx("div",{className:"h-6 w-32 bg-slate-200 dark:bg-slate-700 rounded animate-pulse mb-4"}),e.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:[...Array(5)].map((u,t)=>e.jsx(E.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:t*.1},className:"h-20 bg-slate-200 dark:bg-slate-700 rounded-xl animate-pulse"},t))})]}),e.jsxs("div",{className:"backdrop-blur-lg bg-white/10 dark:bg-slate-900/20 rounded-xl border border-white/20 dark:border-slate-700/30 shadow-xl p-6",children:[e.jsx("div",{className:"h-6 w-40 bg-slate-200 dark:bg-slate-700 rounded animate-pulse mb-4"}),e.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:[...Array(5)].map((u,t)=>e.jsx(E.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:t*.1},className:"h-20 bg-slate-200 dark:bg-slate-700 rounded-xl animate-pulse"},t))})]})]})]})}function te(){const[u,t]=l.useState(.8),[i,h]=l.useState(null),[n,c]=l.useState(null),x=P(),{data:o,isLoading:g}=R({queryKey:["reconciliation","expenses"],queryFn:S.getExpenses}),{data:v,isLoading:b}=R({queryKey:["reconciliation","transactions"],queryFn:S.getTransactions}),f=_({mutationFn:async()=>{const a=await fetch("http://localhost:8000/api/v1/reconciliation/auto-reconcile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({threshold:u})});if(!a.ok)throw new Error("Auto-reconciliation failed");return a.json()},onSuccess:()=>{x.invalidateQueries({queryKey:["reconciliation"]}),p.success("Auto-reconciliation completed")},onError:a=>{p.error(`Reconciliation failed: ${a instanceof Error?a.message:"Unknown error"}`)}}),[m,y]=l.useState(""),[j,k]=l.useState(""),C=_({mutationFn:a=>S.uploadTransactions(a[0],m,j),onSuccess:()=>{x.invalidateQueries({queryKey:["reconciliation"]}),p.success("Transactions uploaded successfully"),y(""),k("")},onError:a=>{p.error(`Upload failed: ${a instanceof Error?a.message:"Unknown error"}`)}}),F=a=>{if(!m||!j){p.error("Please enter Subject ID and Bank Name");return}a.length>0&&C.mutate(a)},N=(a,r)=>{h({id:a,type:r})},w=(a,r)=>{a.preventDefault(),i&&i.type!==(o?.find(U=>U.id===r)?"expense":"bank")&&c(r)},D=()=>{c(null)},s=async(a,r,U)=>{if(a.preventDefault(),c(null),!!i){if(i.type===U){p.error("Cannot match items of the same type");return}try{await S.createMatch(i.id,r),x.invalidateQueries({queryKey:["reconciliation"]}),p.success("Match created successfully"),x.invalidateQueries({queryKey:["reconciliation"]})}catch{p.error("Failed to create match")}h(null)}};return g||b?e.jsx(L,{pageName:"Reconciliation",children:e.jsx(V,{})}):e.jsx(L,{pageName:"Reconciliation",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"Transaction Reconciliation"}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400",children:["Confidence Threshold:",e.jsx("input",{type:"range",min:"0.5",max:"1",step:"0.05",value:u,onChange:a=>t(parseFloat(a.target.value)),className:"w-32"}),e.jsxs("span",{className:"font-medium",children:[Math.round(u*100),"%"]})]}),e.jsxs("button",{onClick:()=>f.mutate(),disabled:f.isPending,className:"flex items-center gap-2 px-4 py-2 backdrop-blur-md bg-blue-600/90 dark:bg-blue-500/90 text-white rounded-xl hover:bg-blue-700 dark:hover:bg-blue-600 transition-all shadow-lg shadow-blue-500/20 font-medium border border-blue-400/20 disabled:opacity-50",children:[e.jsx(I,{className:"h-5 w-5"}),f.isPending?"Running...":"Auto-Reconcile"]})]})]}),e.jsxs("div",{className:"backdrop-blur-lg bg-white/10 dark:bg-slate-900/20 rounded-xl border border-white/20 dark:border-slate-700/30 shadow-xl p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white mb-4",children:"Upload Transactions"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Subject ID (UUID)"}),e.jsx("input",{type:"text",value:m,onChange:a=>y(a.target.value),className:"w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white",placeholder:"e.g. 123e4567-e89b-12d3-a456-426614174000"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Bank Name"}),e.jsx("input",{type:"text",value:j,onChange:a=>k(a.target.value),className:"w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white",placeholder:"e.g. Chase"})]})]}),e.jsx(J,{onUpload:F})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"backdrop-blur-lg bg-white/10 dark:bg-slate-900/20 rounded-xl border border-white/20 dark:border-slate-700/30 shadow-xl p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white mb-4",children:["Expenses (",o?.length??0,")"]}),e.jsxs("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:[o?.map(a=>e.jsx("div",{draggable:a.status!=="matched",onDragStart:()=>N(a.id,"expense"),onDragOver:r=>w(r,a.id),onDragLeave:D,onDrop:r=>s(r,a.id,"expense"),className:n===a.id?"ring-2 ring-blue-500 rounded-xl":"",children:e.jsx(M,{id:a.id,type:"expense",date:a.date,description:a.description,amount:a.amount,status:a.status})},a.id)),o?.length===0&&e.jsx("div",{className:"text-center py-8 text-slate-500",children:"No expenses found"})]})]}),e.jsx("div",{className:"hidden lg:flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx($,{className:"h-12 w-12 text-purple-400 dark:text-cyan-400"}),e.jsx("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:"Drag to match"})]})}),e.jsxs("div",{className:"backdrop-blur-lg bg-white/10 dark:bg-slate-900/20 rounded-xl border border-white/20 dark:border-slate-700/30 shadow-xl p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white mb-4",children:["Transactions (",v?.length??0,")"]}),e.jsxs("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:[v?.map(a=>e.jsx("div",{draggable:a.status!=="matched",onDragStart:()=>N(a.id,"bank"),onDragOver:r=>w(r,a.id),onDragLeave:D,onDrop:r=>s(r,a.id,"bank"),className:n===a.id?"ring-2 ring-blue-500 rounded-xl":"",children:e.jsx(M,{id:a.id,type:"bank",date:a.date,description:a.description,amount:a.amount,status:a.status})},a.id)),v?.length===0&&e.jsx("div",{className:"text-center py-8 text-slate-500",children:"No transactions found"})]})]})]})]})})}export{te as Reconciliation};
